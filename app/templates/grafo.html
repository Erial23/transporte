{% extends "base.html" %}
{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.net.min.js"></script>

<style>
    #vanta-canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
    }

    .glass-panel {
        background: rgba(10, 20, 40, 0.7);
        backdrop-filter: blur(15px);
        border-radius: 25px;
        border: 1px solid rgba(0, 198, 255, 0.3);
        color: white;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
    }

    #map-principal {
        height: 750px;
        border-radius: 25px;
        border: 2px solid rgba(0, 198, 255, 0.3);
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }

    .form-select-cyber {
        background: rgba(255, 255, 255, 0.1) !important;
        border: 1px solid rgba(0, 198, 255, 0.4) !important;
        color: white !important;
        border-radius: 12px;
    }

    .instruction-step {
        background: rgba(255, 255, 255, 0.05);
        border-left: 4px solid #00c6ff;
        transition: 0.3s;
    }

    .instruction-step:hover {
        background: rgba(0, 198, 255, 0.1);
    }
</style>

<div id="vanta-canvas"></div>

<div class="row g-4 position-relative">
    <div class="col-md-4">
        <div class="card glass-panel p-4 mb-4 border-0">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold text-info m-0">üóÇÔ∏è Rutas Guardadas</h5>
                <a href="{{ url_for('grafo.rutas_guardadas') }}" class="btn btn-sm btn-outline-info py-1 px-3" style="border-radius: 10px;">Ver todas</a>
            </div>
            
            <form action="{{ url_for('grafo.index') }}" method="GET">
                <label class="small fw-bold text-white opacity-75 mb-2">SELECCIONAR RUTA:</label>
                <select name="ruta_id" class="form-select form-select-cyber p-3 mb-2" onchange="this.form.submit()">
                    <option value="" class="text-dark">-- Elige una ruta --</option>
                    {% for r in rutas_guardadas %}
                    <option value="{{ r.id }}" class="text-dark" {% if ruta_seleccionada and ruta_seleccionada.id == r.id %}selected{% endif %}>
                        {{ r.nombre_ruta }}
                    </option>
                    {% endfor %}
                </select>
            </form>
        </div>

        {% if instrucciones %}
        <div class="card glass-panel p-4 border-0" style="max-height: 500px; overflow-y: auto;">
            <h5 class="fw-bold text-info mb-1">üö∂ Gu√≠a de Ruta</h5>
            <p class="small text-white opacity-50 mb-3">Distancia calculada por calles.</p>
            <div class="list-group list-group-flush">
                {% for paso in instrucciones %}
                <div class="mb-3 p-2 instruction-step rounded shadow-sm">
                    <div class="d-flex justify-content-between">
                        <span class="badge bg-info text-dark">Paso {{ paso.paso }}</span>
                        <small class="fw-bold text-info">{{ paso.distancia }} km</small>
                    </div>
                    <div class="small mt-2 text-white">
                        De: <b>{{ paso.desde }}</b><br>
                        A: <b>{{ paso.hacia }}</b>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <div class="col-md-8">
        <div id="map-principal"></div>
    </div>
</div>

<script>
    VANTA.NET({
      el: "#vanta-canvas",
      mouseControls: true,
      touchControls: true,
      gyroControls: false,
      minHeight: 200.00,
      minWidth: 200.00,
      scale: 1.00,
      scaleMobile: 1.00,
      color: 0x00c6ff,
      backgroundColor: 0x050a18,
      points: 15.00,
      maxDistance: 20.00,
      spacing: 15.00
    });

    var map = L.map('map-principal').setView([-1.249, -78.627], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    {% if puntos_json %}
        var pts = {{ puntos_json|safe }};
        var waypoints = pts.map(p => L.latLng(p.lat, p.lng));

        if (waypoints.length >= 2) {
            L.Routing.control({
                waypoints: waypoints,
                language: 'es',
                lineOptions: {
                    styles: [{ color: '#00c6ff', opacity: 0.8, weight: 8 }]
                },
                addWaypoints: false,
                draggableWaypoints: false,
                show: true,
                createMarker: function(i, wp, n) {
                    var marker = L.marker(wp.latLng);
                    if(i === 0) setTimeout(() => { marker._icon.style.filter = "hue-rotate(140deg) saturate(3)"; }, 100);
                    if(i === n - 1) setTimeout(() => { marker._icon.style.filter = "hue-rotate(300deg) saturate(3)"; }, 100);
                    return marker.bindPopup("<b>" + (i + 1) + ". " + pts[i].nombre + "</b>");
                }
            }).addTo(map);
        }
    {% endif %}
    setTimeout(() => { map.invalidateSize(); }, 400);
</script>
{% endblock %}